<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=320" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<title>data dashboard</title>
	<!--
	<script type="text/javascript" src="http://d3js.org/d3.v2.min.js"></script>
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	-->
	<script type="text/javascript" src="lib/d3.min.js"></script>
	<script type="text/javascript" src="lib/jquery-1.11.1.min.js"></script>

	<link rel='stylesheet' href='css/waterdataStyle.css' type='text/css'/>

</head>
<body>

<div id="day"><h2>today</h2></div>

<div id="wrapper">

<div id="leftWrapper">
	<div id="leftButton"></div>
</div>
<div id="gaugeWrapper">
	<!-- Allgheny River-->
	<div id="allegheny">
		<div>
			<h1>Allegheny</h1>
			<p>Acmetonia, PA<p>
		</div>

		<div class="aPh">
			<div id="phalleghenyGraph"></div>
			<div id="alleghenyPhGauge"></div>
			<div id="acmetoniaPh-gauge-label"><p>Readings from:</p></div>
		</div>

		<div class="aPh">
			<div id="tempalleghenyGraph"></div>
			<div id="alleghenyTempGauge"></div>
			<div id="acmetoniaTemp-gauge-label"><p>Readings from:</p></div>
		</div>

		<div id="alleghenyHeightGauge"></div>
		<div id="acmetoniaHeight-gauge-label"><p>Readings from:</p></div>
	</div>


	<!-- Monongahela River-->
	<div id="monongahela">
		<div>
			<h1>Monongahela</h1>
			<p>Elizabeth, PA<p>
		</div>
		
		<div class="mPh">
			<div id="phmonongahelaGraph"></div>
			<div id="monongahelaPhGauge"></div>
			<div id="elizabethPh-gauge-label"><p>Readings from:</p></div>
		</div>

		<div class="mPh">
			<div id="tempmonongahelaGraph"></div>
			<div id="monongahelaTempGauge"></div>
			<div id="elizabethTemp-gauge-label"><p>Readings from:</p></div>
		</div>

		<div id="monongahelaHeightGauge"></div>
		<div id="elizabethHeight-gauge-label"><p>Readings from:</p></div>
	</div>


	<!-- Ohio River-->
	<div id="ohio">
		<div>
			<h1>Ohio</h1>
			<p>Ohioview, PA<p>
		</div>

		<div id="oPh">
			<div id="phohioGraph"></div>
			<div id="ohioPhGauge"></div>
			<div id="ohioviewPh-gauge-label"><p>Readings from:</p></div>
		</div>

		<div id="oPh">
			<div id="tempohioGraph"></div>
			<div id="ohioTempGauge"></div>
			<div id="ohioviewTemp-gauge-label"><p>Readings from:</p></div>
		</div>

		<div id="ohioHeightGauge"></div>
		<div id="ohioviewHeight-gauge-label"><p>Readings from:</p></div>
	</div>
</div>

<div id="rightWrapper">
	<div id="rightButton"></div>
</div>

</div>
<div id="textinput"></div>

<script type="text/javascript" src="js/phGauge.js"></script>
<script type="text/javascript" src="js/temperatureGauge.js"></script>
<script type="text/javascript" src="js/heightGauge.js"></script>

<script type="text/javascript" src="js/dailyGraph.js"></script>
<!-- <script type="text/javascript" src="js/instantGraph.js"></script> -->

<script>

var rivers = ["allegheny", "monongahela", "ohio"];
var locations = ["acmetonia", "elizabeth", "ohioview"];
var values = [{ph:'7.6', phTime:'15:00', temp:'4', tempTime: '15:00', height:'12.12', heightTime:'15:00'},
			  {ph:'7.6', phTime:'15:00', temp:'7', tempTime: '15:00', height:'11.93', heightTime:'15:00'},
			  {ph:'7.6', phTime:'15:00', temp:'6', tempTime: '15:00', height:'12.51', heightTime:'15:00'}];

var phGauges = [];
var temperatureGauges = [];
var heightGauges = [];

var status = 2; // 0,1,2 indicates on what "page" we are 6 months ago, yesterday or today

// hide graphs
$('#ph'+rivers[0]+'Graph').hide();
$('#ph'+rivers[1]+'Graph').hide();
$('#ph'+rivers[2]+'Graph').hide();

$('#temp'+rivers[0]+'Graph').hide();
$('#temp'+rivers[1]+'Graph').hide();
$('#temp'+rivers[2]+'Graph').hide();

function onDocumentReady() {

	/* ------------ GAUGES ------------- GAUGES ------------- GAUGES ------------- */

	function createPhGauge(cssID, label) {
		var config = {
			size: 215,
			label: label,
			min: 0,
			max: 14,
			minorTicks: 1,
			majorTicks: 15
		}
						
		phGauges[cssID] = new PhGauge(cssID + "PhGauge", config);
		phGauges[cssID].render();
	}

	createPhGauge("allegheny");
	createPhGauge("monongahela");
	createPhGauge("ohio");

	function createTemperatureGauge(cssID){
		var config = {
			size: 210,
			min: 30,
			max: 90,
			minorTicks: 10,
			majorTicks: 7,
			transitionMs: 3000
		}
						
		temperatureGauges[cssID] = new TemperatureGauge(cssID + "TempGauge", config);
		temperatureGauges[cssID].render();
	}

	createTemperatureGauge("allegheny");
	createTemperatureGauge("monongahela");
	createTemperatureGauge("ohio");


	function createHeightGauge(cssID, label, fl) {
		var config = {
			size: 230,
			label: label,
			max: 34,
			floodLevel: fl
		}
						
		heightGauges[cssID] = new HeightGauge(cssID + "HeightGauge", config);
		heightGauges[cssID].render();
	}

	createHeightGauge("allegheny", "allegheny", 17);
	createHeightGauge("monongahela", "monongahela", 20);
	createHeightGauge("ohio", "ohio", 33);


	//initial reading values
	// getIVdata(rivers[0]);
	// getIVdata(rivers[1]);
	// getIVdata(rivers[2]);

	updateGauges(0, status);
	updateGauges(1, status);
	updateGauges(2, status);

	//updates gauges from locally saved json data
	function updateGauges(l, time){
	
		var riverData = "riverData/"+rivers[l]+"PA-IV-"+time+".json";
	
		$.getJSON( riverData, function( data ) { 
			updateRiverGauges(data, l, time);
				//console.log(data);
				//console.log(location + ": json data UI:30sec (no internet connection)");
		}).fail(function( jqxhr, textStatus, error ) {
			var err = textStatus + ", " + error;
			console.error( "Problem with local data: " + err);
		});
	}

	// update the data for all gauges and labels
	function updateRiverGauges(data, l, dateValue){

		var dv = dateValue;
		//console.log(location+": " + dv);
		var idTemperature, idPh, idHeight;

		// check if all 3 values were received and set id to access the arrays and update values array with values from json file
		for (var i=0; i < data.value.timeSeries.length; i++) {
			switch(data.value.timeSeries[i].name.substr(data.value.timeSeries[0].name.length - 9).substr(0,3)){
				case '400': // PH
					idPh = i;
					values[l].ph = data.value.timeSeries[idPh].values[0].value[0].value;
					values[l].phTime = data.value.timeSeries[idPh].values[0].value[0].dateTime;
					break;	
				case '010': // temperature
					idTemperature = i;
					values[l].temp = data.value.timeSeries[idTemperature].values[0].value[0].value;
					values[l].tempTime = data.value.timeSeries[idTemperature].values[0].value[0].dateTime;
					break;
				case '065': // Gauge Height
					idHeight = i;
					values[l].height = data.value.timeSeries[idHeight].values[0].value[0].value;
					values[l].heightTime = data.value.timeSeries[idHeight].values[0].value[0].dateTime;
					break;
			}
		};

		phGauges[rivers[l]].reset(1);
		phGauges[rivers[l]].redraw(values[l].ph);
		$('#'+locations[l]+'Ph-gauge-label p').remove();
		$('#'+locations[l]+'Ph-gauge-label').append('<p>Readings from: ' + formatDateToDisplay(values[l].phTime)+ ' at: ' + formatTimeToDisplay(values[l].phTime)+'</p>');

		temp = convertCtoF(values[l].temp);
		temperatureGauges[rivers[l]].redraw(temp);
		$('#'+locations[l]+'Temp-gauge-label p').remove();
		$('#'+locations[l]+'Temp-gauge-label').append('<p>Readings from: ' + formatDateToDisplay(values[l].tempTime)+ ' at: ' + formatTimeToDisplay(values[l].tempTime)+'</p>');

		heightGauges[rivers[l]].reset(1);
		heightGauges[rivers[l]].redraw(values[l].height);
		$('#'+locations[l]+'Height-gauge-label p').remove();
		$('#'+locations[l]+'Height-gauge-label').append('<p>Readings from: ' + formatDateToDisplay(values[l].heightTime)+ ' at: ' + formatTimeToDisplay(values[l].heightTime)+'</p>');

		//console.log("temp:"+temp+" tempTime:"+tempTime+" gageHeight:"+gageHeight+" gageHeightTime:"+gageHeightTime+" ph:"+ph+" phTime:"+phTime);
	}

	// capitalizes the first Letter of the string
	function capFirstLetter(string){

		return string.charAt(0).toUpperCase() + string.slice(1);
	}

	// extract date to display
	function formatDateToDisplay(string){
		var date = string.substr(0, 10);

		var year = date.substr(0, 4);
		var month = date.substr(5,2);
		var day = date.substr(8, 5);

		date = month+"/"+day+"/"+year;

		return date;
	}

	// extract time to display
	function formatTimeToDisplay(string){
		
		var time = string.substr(11,5);
		var hour = time.substr(0,2);
		var minutes = time.substr(3,4);
		
		if(parseInt(hour) > 12){
			hour = hour - 12;
			time = hour+":"+minutes+" pm";
		} else {
			time = time + "am";
		}
		return time;
	}

	// convert C to F
	function convertCtoF(c){
		// (°C × 9/5) + 32
		var f = c * 1.8 + 32;
		f = Math.round(f*100)/100;
		return f;
	}

	// handles the click event, sends the query
	function getIVdata(location) {

	   $.ajax({
	   	  type: "POST",
	      url:'php/saveInstantValues.php',
	      data: {riverLocation:location},
	      complete: function (response) {
	          console.log(location + ": updated json file");
	      },
	      error: function () {
	          console.error(location + ': Bummer: there was an error!');
	      },
	  });
	  return false;
	}

	$('#leftButton').click(function() {
		
		if(status > 2) status = 2;
		status--;		

		$('#rightButton').show();

		switch(parseInt(status)){
			case 0: // 6 months ago
				$('#day').html("<h2>4 months ago</h2>");
				$('#leftButton').css("opacity", .3);
				break;
			case 1: // yesterday
				$('#day').html("<h2>yesterday</h2>");
				$('#leftButton').css("opacity", 1);
				$('#rightButton').css("opacity", 1);
				break;
			case 2: // today
				$('#day').html("<h2>today</h2>");
				$('#leftButton').css("opacity", 1);
				break;
			default:
				// console.error("problem updating gauges");
				break;	
		}

		//console.log(status);
		if(status >= 0){
			updateGauges(0, status);
			updateGauges(1, status);
			updateGauges(2, status);

			resetGraphToGauge();
		}
	});

	$('#rightButton').click(function() {
		
		if(status < 0) status = 0;
		status++;

		$('#leftButton').show();

		switch(parseInt(status)){
			case 0: // 6 months ago
				$('#day').html("<h2>6 months ago</h2>");
				$('#rightButton').css("opacity", 1);
				break;
			case 1: // yesterday
				$('#day').html("<h2>yesterday</h2>");
				$('#leftButton').css("opacity", 1);
				$('#rightButton').css("opacity", 1);
				break;
			case 2: // today
				$('#day').html("<h2>today</h2>");
				$('#rightButton').css("opacity", .3);
				break;
			default:
				//alert("none of the above");
				break;
		}
		//console.log(status);
		if(status < 3){
			updateGauges(0, status);
			updateGauges(1, status);
			updateGauges(2, status);

			resetGraphToGauge();
		}
	});

	// every few minutes update reading values
	setInterval(function() {
		updateGauges(0, status);
		updateGauges(1, status);
		updateGauges(2, status);
	}, 300000); // 30 minutes (1800000 millliseconds), updateInterval (300000 = 5 min)


	/* ----------- GRAPHS -------------- GRAPHS ------------- GRAPHS ------------- */

	function createDailyGraph(cssID, type, location, min, max) {

		var newData = [];
		var parseDate = d3.time.format("%Y-%m-%d").parse;

		d3.json("riverData/"+location+"PA-DV.json", function(error, data) {

            var graphData = data.value.timeSeries[type].values[0].value;            

            if(graphData.length > 70){
	            for (var i = 0; i < graphData.length; i += 5){
	                var dateString = graphData[i].dateTime;
	                var newDataObject = {};
	                dateString = dateString.substring(0,10);
	                newData.push({date:parseDate(dateString), value:graphData[i].value});
	            }
	            newData.push({date:parseDate(dateString), value:graphData[graphData.length-1].value});
	        } else {
	        	graphData.forEach(function(d) {
	                var dateString = d.dateTime;
	                var newDataObject = {};
	                dateString = dateString.substring(0,10);
	                newData.push({date:parseDate(dateString), value:d.value});
            	});
	        }

            var config = {
	        	min: min,
	        	max: max,
				data: newData
			}
						
			phGauges[cssID] = new DailyGraph(cssID, config);
			phGauges[cssID].render();

        });
	}

	function resetGraphToGauge(){
		for(var i=0; i<rivers.length; i++){
			$('#'+rivers[i]+'PhGauge').show();
			$( "#ph"+rivers[i]+"Graph" ).hide();

			$('#'+rivers[i]+'TempGauge').show();
			$( "#temp"+rivers[i]+"Graph" ).hide();
		}
	}

	createDailyGraph("phalleghenyGraph", 5, rivers[0], 6.8, 9);
	createDailyGraph("phmonongahelaGraph", 5, rivers[1], 6.8, 9);
	createDailyGraph("phohioGraph", 3, rivers[2], 6.8, 9);

	createDailyGraph("tempalleghenyGraph", 2, rivers[0], -1, 33);
	createDailyGraph("tempmonongahelaGraph", 2, rivers[1], -1, 33);
	createDailyGraph("tempohioGraph", 2, rivers[2], -1, 33);

	// PH
	$('#'+rivers[0]+'PhGauge').click(function() {
		$( "#ph"+rivers[0]+"Graph" ).show();
		$('#'+rivers[0]+'PhGauge').hide();
		$('#'+locations[0]+'Ph-gauge-label p').hide();
	});
	$('#ph'+rivers[0]+'Graph').click(function() {
		$('#'+rivers[0]+'PhGauge').show();
		$( "#ph"+rivers[0]+"Graph" ).hide();
		$('#'+locations[0]+'Ph-gauge-label p').show();
	});

	$('#'+rivers[1]+'PhGauge').click(function() {
		$( "#ph"+rivers[1]+"Graph" ).show();
		$('#'+rivers[1]+'PhGauge').hide();
		$('#'+locations[1]+'Ph-gauge-label p').hide();
	});
	$('#ph'+rivers[1]+'Graph').click(function() {
		$('#'+rivers[1]+'PhGauge').show();
		$( "#ph"+rivers[1]+"Graph" ).hide();
		$('#'+locations[1]+'Ph-gauge-label p').show();
	});

	$('#'+rivers[2]+'PhGauge').click(function() {
		$( "#ph"+rivers[2]+"Graph" ).show();
		$('#'+rivers[2]+'PhGauge').hide();
		$('#'+locations[2]+'Ph-gauge-label p').hide();
	});
	$('#ph'+rivers[2]+'Graph').click(function() {
		$('#'+rivers[2]+'PhGauge').show();
		$( "#ph"+rivers[2]+"Graph" ).hide();
		$('#'+locations[2]+'Ph-gauge-label p').show();
	});

	// TEMPERATURES
	$('#'+rivers[0]+'TempGauge').click(function() {
		$( "#temp"+rivers[0]+"Graph" ).show();
		$('#'+rivers[0]+'TempGauge').hide();
		$('#'+locations[0]+'Temp-gauge-label p').hide();
	});
	$('#temp'+rivers[0]+'Graph').click(function() {
		$('#'+rivers[0]+'TempGauge').show();
		$( "#temp"+rivers[0]+"Graph" ).hide();
		$('#'+locations[0]+'Temp-gauge-label p').show();
	});

	$('#'+rivers[1]+'TempGauge').click(function() {
		$( "#temp"+rivers[1]+"Graph" ).show();
		$('#'+rivers[1]+'TempGauge').hide();
		$('#'+locations[1]+'Temp-gauge-label p').hide();
	});
	$('#temp'+rivers[1]+'Graph').click(function() {
		$('#'+rivers[1]+'TempGauge').show();
		$( "#temp"+rivers[1]+"Graph" ).hide();
		$('#'+locations[1]+'Temp-gauge-label p').show();
	});

	$('#'+rivers[2]+'TempGauge').click(function() {
		$( "#temp"+rivers[2]+"Graph" ).show();
		$('#'+rivers[2]+'TempGauge').hide();
		$('#'+locations[2]+'Temp-gauge-label p').hide();
	});
	$('#temp'+rivers[2]+'Graph').click(function() {
		$('#'+rivers[2]+'TempGauge').show();
		$( "#temp"+rivers[2]+"Graph" ).hide();
		$('#'+locations[2]+'Temp-gauge-label p').show();
	});

	
}

if ( !window.isLoaded ) {
	window.addEventListener("load", function() {
		onDocumentReady();
	}, false);
} else {
	onDocumentReady();
}

</script>

</body>
</html>