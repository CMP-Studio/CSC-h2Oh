<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=320" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<title>data dashboard</title>
	<!--
	<script type="text/javascript" src="http://d3js.org/d3.v2.min.js"></script>
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	-->
	<script type="text/javascript" src="lib/d3.min.js"></script>
	<script type="text/javascript" src="lib/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="lib/jquery.lettering-0.6.1.min.js"></script>

	<link rel='stylesheet' href='css/waterdataStyle.css' type='text/css'/>

</head>
<body>

<div id="day"><h2>today</h2></div>

<div id="wrapper">

<div id="leftWrapper">
	<div id="leftButton"></div>
</div>
<div id="gaugeWrapper">
	<!-- Allgheny River-->
	<div id="allegheny">
		<div>
			<h1>Allegheny</h1>
			<p>Acmetonia, PA<p>
		</div>

		<div class="aPh" >
			<div id="phalleghenyGraph"></div>
			<div id="acmetoniaPh-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="alleghenyPhGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
			
		</div>

		<div class="aPh">
			<div id="tempalleghenyGraph"></div>
			<div id="acmetoniaTemp-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="alleghenyTempGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>

		<div class="aPh">
			<div id="heightalleghenyGraph"></div>
			<div id="acmetoniaHeight-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="alleghenyHeightGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>
	</div>


	<!-- Monongahela River-->
	<div id="monongahela">
		<div>
			<h1>Monongahela</h1>
			<p>Elizabeth, PA<p>
		</div>
		
		<div class="mPh">
			<div id="phmonongahelaGraph"></div>
			<div id="elizabethPh-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</div>
			<div id="monongahelaPhGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>

		<div class="mPh">
			<div id="tempmonongahelaGraph"></div>
			<div id="elizabethTemp-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="monongahelaTempGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>

		<div class="mPh">
			<div id="heightmonongahelaGraph"></div>
			<div id="elizabethHeight-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="monongahelaHeightGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>
	</div>


	<!-- Ohio River-->
	<div id="ohio">
		<div>
			<h1>Ohio</h1>
			<p>Ohioview, PA<p>
		</div>

		<div id="oPh">
			<div id="phohioGraph"></div>
			<div id="ohioviewPh-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="ohioPhGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>

		<div id="oPh">
			<div id="tempohioGraph"></div>
			<div id="ohioviewTemp-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="ohioTempGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>

		<div id="oPh">
			<div id="heightohioGraph"></div>
			<div id="ohioviewHeight-gauge-label"><p>Last update:<br /> 01/01/2014 <br /> at: 11:00pm</p></div>
			<div id="ohioHeightGauge"><img class="graphButton" src="images/graph.png" width="40px"/></div>
		</div>
	</div>
</div>

<div id="rightWrapper">
	<div id="rightButton"></div>
</div>

</div>
<div id="textinput"></div>

<script type="text/javascript" src="js/phGauge.js"></script>
<script type="text/javascript" src="js/temperatureGauge.js"></script>
<script type="text/javascript" src="js/heightGauge.js"></script>

<script type="text/javascript" src="js/dailyGraph.js"></script>
<!-- <script type="text/javascript" src="js/instantGraph.js"></script> -->

<script>

var NS = "http://www.w3.org/2000/svg";
var svg = document.createElementNS(NS,"svg");

svg.width = 300;
svg.height = 500;

document.body.appendChild(svg);

var SVG = function(h,w){
	var NS = "http://www.w3.org/2000/svg";
	var svg = document.createElementNS(NS,"svg");
	svg.width = w;
	svg.height = h;
	return svg;
}

var svg=SVG(200,500);
document.body.appendChild(svg);

var SVGObj=document.createElementNS(NS,"rect");
SVGObj.setAttributeNS(null,"height",50);



var rivers = ["allegheny", "monongahela", "ohio"];
var locations = ["acmetonia", "elizabeth", "ohioview"];
var values = [{ph:'7.6', phTime:'15:00', temp:'4', tempTime: '15:00', height:'12.12', heightTime:'15:00'},
			  {ph:'7.6', phTime:'15:00', temp:'7', tempTime: '15:00', height:'11.93', heightTime:'15:00'},
			  {ph:'7.6', phTime:'15:00', temp:'6', tempTime: '15:00', height:'12.51', heightTime:'15:00'}];

var phGauges = [];
var temperatureGauges = [];
var heightGauges = [];

var status = 2; // 0,1,2 indicates on what "page" we are 6 months ago, yesterday or today

// hide graphs
$('#ph'+rivers[0]+'Graph').hide();
$('#ph'+rivers[1]+'Graph').hide();
$('#ph'+rivers[2]+'Graph').hide();

$('#temp'+rivers[0]+'Graph').hide();
$('#temp'+rivers[1]+'Graph').hide();
$('#temp'+rivers[2]+'Graph').hide();

$('#height'+rivers[0]+'Graph').hide();
$('#height'+rivers[1]+'Graph').hide();
$('#height'+rivers[2]+'Graph').hide();

function onDocumentReady() {

	/* ------------ GAUGES ------------- GAUGES ------------- GAUGES ------------- */

	function createPhGauge(cssID, label) {
		var config = {
			size: 290,
			label: label,
			min: 0,
			max: 14,
			minorTicks: 1,
			majorTicks: 15
		}
						
		phGauges[cssID] = new PhGauge(cssID + "PhGauge", config);
		phGauges[cssID].render();
	}

	createPhGauge("allegheny");
	createPhGauge("monongahela");
	createPhGauge("ohio");

	function createTemperatureGauge(cssID){
		var config = {
			size: 290,
			min: 30,
			max: 90,
			minorTicks: 10,
			majorTicks: 7,
			transitionMs: 3000
		}
						
		temperatureGauges[cssID] = new TemperatureGauge(cssID + "TempGauge", config);
		temperatureGauges[cssID].render();
	}

	createTemperatureGauge("allegheny");
	createTemperatureGauge("monongahela");
	createTemperatureGauge("ohio");


	function createHeightGauge(cssID, label, fl) {
		var config = {
			size: 285,
			label: label,
			max: 34,
			floodLevel: fl
		}
						
		heightGauges[cssID] = new HeightGauge(cssID + "HeightGauge", config);
		heightGauges[cssID].render();
	}

	createHeightGauge("allegheny", "allegheny", 17);
	createHeightGauge("monongahela", "monongahela", 20);
	createHeightGauge("ohio", "ohio", 33);



	//initial reading values
	getIVdata(rivers[0]);
	getIVdata(rivers[1]);
	getIVdata(rivers[2]);

	updateGauges(0, status, "auto");
	updateGauges(1, status, "auto");
	updateGauges(2, status, "auto");

	//updates gauges from locally saved json data
	function updateGauges(l, time, refreshType){
	
		var riverData = "riverData/"+rivers[l]+"PA-IV-"+time+".json";
	
		$.getJSON( riverData, function( data ) { 
			updateRiverGauges(data, l, time, refreshType);
				//console.log(data);
				//console.log(location + ": json data UI:30sec (no internet connection)");
		}).fail(function( jqxhr, textStatus, error ) {
			var err = textStatus + ", " + error;
			console.error( "Problem with local data: " + err);
		});
	}

	// update the data for all gauges and labels
	function updateRiverGauges(data, l, dateValue, refreshType){

		var dv = dateValue;
		//console.log(location+": " + dv);
		var idTemperature, idPh, idHeight;
		var refreshType = refreshType;
		var parseDate = d3.time.format("%Y-%m-%d").parse;


		// check if all 3 values were received and set id to access the arrays and update values array with values from json file
		for (var i=0; i < data.value.timeSeries.length; i++) {
			switch(data.value.timeSeries[i].name.substr(data.value.timeSeries[0].name.length - 9).substr(0,3)){
				case '400': // PH
					idPh = i;
					values[l].ph = data.value.timeSeries[idPh].values[0].value[0].value;
					values[l].phTime = data.value.timeSeries[idPh].values[0].value[0].dateTime;
					break;	
				case '010': // temperature
					idTemperature = i;
					values[l].temp = data.value.timeSeries[idTemperature].values[0].value[0].value;
					values[l].tempTime = data.value.timeSeries[idTemperature].values[0].value[0].dateTime;
					break;
				case '065': // Gauge Height
					idHeight = i;
					values[l].height = data.value.timeSeries[idHeight].values[0].value[0].value;
					values[l].heightTime = data.value.timeSeries[idHeight].values[0].value[0].dateTime;
					if(refreshType.localeCompare("auto") == 0){
						dateString = values[l].heightTime;
						dateString = dateString.substring(0,10);
						//console.log("update gauges: "+dateString);
						var ghData = dateString + "," + values[l].height;
						saveGaugeHeight(rivers[l], ghData);
					}
					break;
			}
		};

		var date = formatDateToDisplay(values[l].phTime).split('');
		var time = formatTimeToDisplay(values[l].phTime).split('');

		phGauges[rivers[l]].reset(1);
		phGauges[rivers[l]].redraw(values[l].ph, 'Last updated: ' + formatDateToDisplay(values[l].phTime)+ ' at: ' + formatTimeToDisplay(values[l].phTime));
		$('#'+locations[l]+'Ph-gauge-label p').remove();
		$('#'+locations[l]+'Ph-gauge-label').append('<p>Last<br />updated:<br /> '+formatDateToDisplay(values[l].phTime)+' <br /> at: '+formatTimeToDisplay(values[l].phTime)+'</p></div>');

		temp = convertCtoF(values[l].temp);
		temperatureGauges[rivers[l]].redraw(temp);
		$('#'+locations[l]+'Temp-gauge-label p').remove();
		$('#'+locations[l]+'Temp-gauge-label').append('<p>Last<br />updated:<br /> '+formatDateToDisplay(values[l].tempTime)+' <br /> at: '+ formatTimeToDisplay(values[l].tempTime)+'</p></div>');

		heightGauges[rivers[l]].reset(1);
		heightGauges[rivers[l]].redraw(values[l].height);
		$('#'+locations[l]+'Height-gauge-label p').remove();
		$('#'+locations[l]+'Height-gauge-label').append('<p>Last<br />updated:<br /> '+formatDateToDisplay(values[l].heightTime)+' <br /> at: '+ formatTimeToDisplay(values[l].heightTime)+'</p></div>');

		//console.log("temp:"+temp+" tempTime:"+tempTime+" gageHeight:"+gageHeight+" gageHeightTime:"+gageHeightTime+" ph:"+ph+" phTime:"+phTime);
	}

	// capitalizes the first Letter of the string
	function capFirstLetter(string){

		return string.charAt(0).toUpperCase() + string.slice(1);
	}

	// extract date to display
	function formatDateToDisplay(string){
		var date = string.substr(0, 10);

		var year = date.substr(0, 4);
		var month = date.substr(5,2);
		var day = date.substr(8, 5);

		date = month+"/"+day+"/"+year;

		return date;
	}

	// extract time to display
	function formatTimeToDisplay(string){
		
		var time = string.substr(11,5);
		var hour = time.substr(0,2);
		var minutes = time.substr(3,4);
		
		if(parseInt(hour) > 12){
			hour = hour - 12;
			time = hour+":"+minutes+" pm";
		} else {
			time = time + "am";
		}
		return time;
	}

	// convert C to F
	function convertCtoF(c){
		// (°C × 9/5) + 32
		var f = c * 1.8 + 32;
		f = Math.round(f*100)/100;
		return f;
	}

	// handles the click event, sends the query
	function getIVdata(location) {

	   $.ajax({
	   	  type: "POST",
	      url:'php/saveInstantValues.php',
	      data: {riverLocation:location},
	      complete: function (response) {
	          console.log(location + ": updated json file");
	      },
	      error: function () {
	          console.error(location + ': Bummer: there was an error!');
	      },
	  });
	  return false;
	}

	// handles the click event, sends the query
	function saveGaugeHeight(location, gaugeHeightData) {

	   $.ajax({
	   	  type: "POST",
	      url:'php/saveGaugeHeight.php',
	      data: {ghData: gaugeHeightData, loc:location},
	      complete: function (response) {
	          console.log(location + ": added gauge height and saved file");
	      },
	      error: function () {
	          console.error(location + ': Bummer: there was an error!');
	      },
	  });
	  return false;
	}

	$('#leftButton').click(function() {
		
		if(status > 2) status = 2;
		status--;		

		$('#rightButton').show();

		switch(parseInt(status)){
			case 0: // 6 months ago
				$('#day').html("<h2>4 months ago</h2>");
				$('#leftButton').css("opacity", .3);
				break;
			case 1: // yesterday
				$('#day').html("<h2>yesterday</h2>");
				$('#leftButton').css("opacity", 1);
				$('#rightButton').css("opacity", 1);
				break;
			case 2: // today
				$('#day').html("<h2>today</h2>");
				$('#leftButton').css("opacity", 1);
				break;
			default:
				// console.error("problem updating gauges");
				break;	
		}

		//console.log(status);
		if(status >= 0){
			updateGauges(0, status, "button");
			updateGauges(1, status, "button");
			updateGauges(2, status, "button");

			resetGraphToGauge();
		}
	});

	$('#rightButton').click(function() {
		
		if(status < 0) status = 0;
		status++;

		$('#leftButton').show();

		switch(parseInt(status)){
			case 0: // 6 months ago
				$('#day').html("<h2>6 months ago</h2>");
				$('#rightButton').css("opacity", 1);
				break;
			case 1: // yesterday
				$('#day').html("<h2>yesterday</h2>");
				$('#leftButton').css("opacity", 1);
				$('#rightButton').css("opacity", 1);
				break;
			case 2: // today
				$('#day').html("<h2>today</h2>");
				$('#rightButton').css("opacity", .3);
				break;
			default:
				//alert("none of the above");
				break;
		}
		//console.log(status);
		if(status < 3){
			updateGauges(0, status, "button");
			updateGauges(1, status, "button");
			updateGauges(2, status, "button");

			resetGraphToGauge();
		}
	});

	// every few minutes update reading values
	setInterval(function() {
		getIVdata(rivers[0]);
		getIVdata(rivers[1]);
		getIVdata(rivers[2]);

		updateGauges(0, status, "auto");
		updateGauges(1, status, "auto");
		updateGauges(2, status, "auto");
		resetGraphToGauge();
	}, 1800000); // 24hrs = 86400000, 1hrs = 3600000, 30 minutes (1800000 millliseconds), updateInterval (300000 = 5 min)


	/* ----------- GRAPHS -------------- GRAPHS ------------- GRAPHS ------------- */

	/* creates a grpah for each gauge, either from a json or a csv file */

	function createDailyGraph(cssID, type, location, min, max, dataFileType) {

		var newData = [];
		var parseDate = d3.time.format("%Y-%m-%d").parse;
		var fileType = "json";
		var graphs = [];
		if(dataFileType == "Gen") fileType = "csv";
		var file = "riverData/"+location+"PA-"+dataFileType+"."+fileType;

		if(fileType == "json"){

			d3.json(file, function(error, data) {

		            var graphData = data.value.timeSeries[type].values[0].value;

		            if(graphData.length > 70){
			            for (var i = 0; i < graphData.length; i += 5){
			                var dateString = graphData[i].dateTime;
			                var newDataObject = {};
			                dateString = dateString.substring(0,10);
			                newData.push({date:parseDate(dateString), value:graphData[i].value});
			            }
			            var dateString = graphData[graphData.length-1].dateTime;
			            dateString = dateString.substring(0,10);
			            newData.push({date:parseDate(dateString), value:graphData[graphData.length-1].value});
			        } else {
			        	graphData.forEach(function(d) {
			                var dateString = d.dateTime;
			                var newDataObject = {};
			                dateString = dateString.substring(0,10);
			                newData.push({date:parseDate(dateString), value:d.value});
		            	});
			        }

			        //console.log(newData);

		            var config = {
			        	min: min,
			        	max: max,
						data: newData
					}
								
					graphs[cssID] = new DailyGraph(cssID, config);
					graphs[cssID].render();

	        });

		} else if(fileType == "csv") {

			d3.csv(file, function(error, data) {

				data.forEach(function(d) {
					newData.push({date:parseDate(d.date), value:d.value});
	            });
	            
	            var config = {
		        	min: min,
		        	max: max,
					data: newData
				}

				graphs[cssID] = new DailyGraph(cssID, config);
				graphs[cssID].render();
			});
		}
	}

	function resetGraphToGauge(){
		for(var i=0; i<rivers.length; i++){
			$('#'+rivers[i]+'PhGauge').show();
			$( "#ph"+rivers[i]+"Graph" ).hide();

			$('#'+rivers[i]+'TempGauge').show();
			$( "#temp"+rivers[i]+"Graph" ).hide();

			$('#'+rivers[i]+'HeightGauge').show();
			$( "#height"+rivers[i]+"Graph" ).hide();
		}
	}
					//cssID, type, location, min, max, dataFileType)
	createDailyGraph("phalleghenyGraph", 5, rivers[0], 6.8, 9, "DV"); // DV or Gen
	createDailyGraph("phmonongahelaGraph", 5, rivers[1], 6.8, 9, "DV"); // DV or Gen
	createDailyGraph("phohioGraph", 3, rivers[2], 6.8, 9, "DV"); // DV or Gen

	createDailyGraph("tempalleghenyGraph", 2, rivers[0], -1, 33, "DV"); // DV or Gen
	createDailyGraph("tempmonongahelaGraph", 2, rivers[1], -1, 33, "DV"); // DV or Gen
	createDailyGraph("tempohioGraph", 2, rivers[2], -1, 33, "DV"); // DV or Gen

	createDailyGraph("heightalleghenyGraph", 10, rivers[0], 10, 33, "Gen"); // DV or Gen
	createDailyGraph("heightmonongahelaGraph", 10, rivers[1], 10, 33, "Gen"); // DV or Gen
	createDailyGraph("heightohioGraph", 10, rivers[2], 10, 33, "Gen"); // DV or Gen

	// PH
	$('#'+rivers[0]+'PhGauge').click(function() {
		$( "#ph"+rivers[0]+"Graph" ).show();
		$('#'+rivers[0]+'PhGauge').hide();
		$('#'+locations[0]+'Ph-gauge-label p').hide();
	});
	$('#ph'+rivers[0]+'Graph').click(function() {
		$('#'+rivers[0]+'PhGauge').show();
		$( "#ph"+rivers[0]+"Graph" ).hide();
		$('#'+locations[0]+'Ph-gauge-label p').show();
	});

	$('#'+rivers[1]+'PhGauge').click(function() {
		$( "#ph"+rivers[1]+"Graph" ).show();
		$('#'+rivers[1]+'PhGauge').hide();
		$('#'+locations[1]+'Ph-gauge-label p').hide();
	});
	$('#ph'+rivers[1]+'Graph').click(function() {
		$('#'+rivers[1]+'PhGauge').show();
		$( "#ph"+rivers[1]+"Graph" ).hide();
		$('#'+locations[1]+'Ph-gauge-label p').show();
	});

	$('#'+rivers[2]+'PhGauge').click(function() {
		$( "#ph"+rivers[2]+"Graph" ).show();
		$('#'+rivers[2]+'PhGauge').hide();
		$('#'+locations[2]+'Ph-gauge-label p').hide();
	});
	$('#ph'+rivers[2]+'Graph').click(function() {
		$('#'+rivers[2]+'PhGauge').show();
		$( "#ph"+rivers[2]+"Graph" ).hide();
		$('#'+locations[2]+'Ph-gauge-label p').show();
	});

	// TEMPERATURES
	$('#'+rivers[0]+'TempGauge').click(function() {
		$( "#temp"+rivers[0]+"Graph" ).show();
		$('#'+rivers[0]+'TempGauge').hide();
		$('#'+locations[0]+'Temp-gauge-label p').hide();
	});
	$('#temp'+rivers[0]+'Graph').click(function() {
		$('#'+rivers[0]+'TempGauge').show();
		$( "#temp"+rivers[0]+"Graph" ).hide();
		$('#'+locations[0]+'Temp-gauge-label p').show();
	});

	$('#'+rivers[1]+'TempGauge').click(function() {
		$( "#temp"+rivers[1]+"Graph" ).show();
		$('#'+rivers[1]+'TempGauge').hide();
		$('#'+locations[1]+'Temp-gauge-label p').hide();
	});
	$('#temp'+rivers[1]+'Graph').click(function() {
		$('#'+rivers[1]+'TempGauge').show();
		$( "#temp"+rivers[1]+"Graph" ).hide();
		$('#'+locations[1]+'Temp-gauge-label p').show();
	});

	$('#'+rivers[2]+'TempGauge').click(function() {
		$( "#temp"+rivers[2]+"Graph" ).show();
		$('#'+rivers[2]+'TempGauge').hide();
		$('#'+locations[2]+'Temp-gauge-label p').hide();
	});
	$('#temp'+rivers[2]+'Graph').click(function() {
		$('#'+rivers[2]+'TempGauge').show();
		$( "#temp"+rivers[2]+"Graph" ).hide();
		$('#'+locations[2]+'Temp-gauge-label p').show();
	});

	// HEIGHT
	$('#'+rivers[0]+'HeightGauge').click(function() {
		$( "#height"+rivers[0]+"Graph").show();
		$('#'+rivers[0]+'HeightGauge').hide();
		$('#'+locations[0]+'Height-gauge-label p').hide();
	});
	$('#height'+rivers[0]+'Graph').click(function() {
		$('#'+rivers[0]+'HeightGauge').show();
		$( "#height"+rivers[0]+"Graph" ).hide();
		$('#'+locations[0]+'Height-gauge-label p').show();
	});

	$('#'+rivers[1]+'HeightGauge').click(function() {
		$( "#height"+rivers[1]+"Graph" ).show();
		$('#'+rivers[1]+'HeightGauge').hide();
		$('#'+locations[1]+'Height-gauge-label p').hide();
	});
	$('#height'+rivers[1]+'Graph').click(function() {
		$('#'+rivers[1]+'HeightGauge').show();
		$( "#height"+rivers[1]+"Graph" ).hide();
		$('#'+locations[1]+'Height-gauge-label p').show();
	});

	$('#'+rivers[2]+'HeightGauge').click(function() {
		$( "#height"+rivers[2]+"Graph").show();
		$('#'+rivers[2]+'HeightGauge').hide();
		$('#'+locations[2]+'Height-gauge-label p').hide();
	});
	$('#height'+rivers[2]+'Graph').click(function() {
		$('#'+rivers[2]+'HeightGauge').show();
		$( "#height"+rivers[2]+"Graph" ).hide();
		$('#'+locations[2]+'Height-gauge-label p').show();
	});
}

if ( !window.isLoaded ) {
	window.addEventListener("load", function() {
		onDocumentReady();
	}, false);
} else {
	onDocumentReady();
}

</script>


</body>
</html>