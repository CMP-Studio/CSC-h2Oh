<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=320" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<title>data dashboard</title>
	<!--
	<script type="text/javascript" src="http://d3js.org/d3.v2.min.js"></script>
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	-->
	<script type="text/javascript" src="lib/d3.min.js"></script>
	<script type="text/javascript" src="lib/jquery-1.11.1.min.js"></script>

	<link rel='stylesheet' href='css/waterdataStyle.css' type='text/css'/>

</head>
<body>

<div id="day"><h2>today</h2></div>

<div id="wrapper">

<div id="leftWrapper">
	<div id="leftButton"></div>
</div>
<div id="gaugeWrapper">
	<!-- Allgheny River-->
	<div id="allegheny">
		<div>
			<h1>Allegheny</h1>
			<p>Acmetonia, PA<p>
		</div>

		<div id="alleghenyPhGauge"></div>
		<div id="acmetoniaPh-gauge-label"><p></p></div>

		<div id="alleghenyTempGauge"></div>
		<div id="acmetoniaTemp-gauge-label"><p></p></div>

		<div id="alleghenyHeightGauge"></div>
		<div id="acmetoniaHeight-gauge-label"><p></p></div>
	</div>


	<!-- Monongahela River-->
	<div id="monongahela">
		<div>
			<h1>Monongahela</h1>
			<p>Elizabeth, PA<p>
		</div>
		
		<div id="mPh">
			<div id="mGraph"></div>
			<div id="monongahelaPhGauge"></div>
			<div id="elizabethPh-gauge-label"><p></p></div>
		</div>

		<div id="monongahelaTempGauge"></div>
		<div id="elizabethTemp-gauge-label"><p></p></div>

		<div id="monongahelaHeightGauge"></div>
		<div id="elizabethHeight-gauge-label"><p></p></div>
	</div>


	<!-- Ohio River-->
	<div id="ohio">
		<div>
			<h1>Ohio</h1>
			<p>Ohioview, PA<p>
		</div>

		<div id="ohioPhGauge"></div>
		<div id="ohioviewPh-gauge-label"><p></p></div>

		<div id="ohioTempGauge"></div>
		<div id="ohioviewTemp-gauge-label"><p></p></div>

		<div id="ohioHeightGauge"></div>
		<div id="ohioviewHeight-gauge-label"><p></p></div>
	</div>
</div>

<div id="rightWrapper">
	<div id="rightButton"></div>
</div>

</div>
<div id="textinput"></div>

<script type="text/javascript" src="js/phGauge.js"></script>
<script type="text/javascript" src="js/temperatureGauge.js"></script>
<script type="text/javascript" src="js/heightGauge.js"></script>

<script>

// hide graphs
$('#mGraph').hide();
$('#rightButton').hide();

//rivers
var river1 = "acmetonia";
var river2 = "elizabeth";
var river3 = "ohioview";

// variable to store data over time
var alleghenyGageHeight;
var alleghenyTemp;
var alleghenyPh;

var monongahelaGageHeight;
var monongahelaTemp;
var monongahelaPh;

var ohioGageHeight;
var ohioTemp;
var ohioPh;

var status = 2; // 0,1,2 indicates on what "page" we are 6 months ago, yesterday or today

function onDocumentReady() {


	var phGauges = [];

	function createPhGauge(name, label, min, max) {
		var config = {
			size: 215,
			label: label,
			min: 0,
			max: 14,
			minorTicks: 1,
			majorTicks: 15
		}
						
		phGauges[name] = new PhGauge(name + "PhGauge", config);
		phGauges[name].render();
	}

	createPhGauge("allegheny");
	createPhGauge("monongahela");
	createPhGauge("ohio");


	var temperatureGauges = [];

	function createTemperatureGauge(name){
		var config = {
			size: 210,
			min: 30,
			max: 90,
			minorTicks: 10,
			majorTicks: 7,
			transitionMs: 3000
		}
						
		temperatureGauges[name] = new TemperatureGauge(name + "TempGauge", config);
		temperatureGauges[name].render();
	}

	createTemperatureGauge("allegheny");
	createTemperatureGauge("monongahela");
	createTemperatureGauge("ohio");



	var heightGauges = [];

	function createheightGauge(name, label, fl) {
		var config = {
			size: 230,
			label: label,
			max: 34,
			floodLevel: fl
		}
						
		heightGauges[name] = new HeightGauge(name + "HeightGauge", config);
		heightGauges[name].render();
	}

	createheightGauge("allegheny", "allegheny", 17);
	createheightGauge("monongahela", "monongahela", 20);
	createheightGauge("ohio", "ohio", 33);

	/*
	 * updates gauges from locally saved json data
	 */
	function updateGauges(location, time){

		console.log(location+" "+time);
		var riverData = "riverData/"+location+"PA-IV-"+time+".json";

		$.getJSON( riverData, function( data ) { 
			updateRiverGauges(data, location, time);
				//console.log(location + ": json data UI:30sec (no internet connection)");
		}).fail(function( jqxhr, textStatus, error ) {
			var err = textStatus + ", " + error;
			console.error( "Problem with local data: " + err);
		});
	}
	
	// initial reading values
	// getIVdata("acmetonia");
	// getIVdata("elizabeth");
	// getIVdata("ohioview");

	updateGauges(river1, status);
	updateGauges(river2, status);
	updateGauges(river3, status);

	// every few minutes update reading values
	setInterval(function() {
		updateGauges(river1, status);
		updateGauges(river2, status);
		updateGauges(river3, status);

	}, 300000); // 30 minutes (1800000 millliseconds), updateInterval (300000 = 5 min)

	// update the data for all gauges and labels
	function updateRiverGauges(data, location, dateValue){

		var dv = dateValue;
		//console.log(location+": " + dv);

		// get data from json response
		temp = data.value.timeSeries[0].values[0].value[0].value;
		tempTime = data.value.timeSeries[0].values[0].value[0].dateTime;
		gageHeight = data.value.timeSeries[1].values[0].value[0].value;
		gageHeightTime = data.value.timeSeries[1].values[0].value[0].dateTime;
		ph = data.value.timeSeries[2].values[0].value[0].value;
		phTime = data.value.timeSeries[2].values[0].value[0].dateTime;

		//console.log("temp:"+temp+" tempTime:"+tempTime+" gageHeight:"+gageHeight+" gageHeightTime:"+gageHeightTime+" ph:"+ph+" phTime:"+phTime);

		temp = convertCtoF(temp);

		
		//update gauges
		switch(location){
			case "acmetonia":
				phGauges["allegheny"].reset(1);
				phGauges["allegheny"].redraw(ph);
				temperatureGauges["allegheny"].redraw(temp);
				heightGauges["allegheny"].reset(1);
				heightGauges["allegheny"].redraw(gageHeight);
				break;
			case "elizabeth":
				phGauges["monongahela"].reset(1);
				phGauges["monongahela"].redraw(ph);
				temperatureGauges["monongahela"].redraw(temp);
				heightGauges["monongahela"].reset(1);
				heightGauges["monongahela"].redraw(gageHeight);
				break;
			case "ohioview":
				phGauges["ohio"].reset(1);
				phGauges["ohio"].redraw(ph);
				temperatureGauges["ohio"].redraw(temp);
				heightGauges["ohio"].reset(1);
				heightGauges["ohio"].redraw(gageHeight);
				break;
		}
		//console.error(formatDateToDisplay(phTime));

		$('#'+location+'Ph-gauge-label p').remove();
		$('#'+location+'Temp-gauge-label p').remove();
		$('#'+location+'Height-gauge-label p').remove();
		$('#'+location+'Ph-gauge-label').append('<p>Readings from: ' + formatDateToDisplay(phTime)+ ' at: ' + formatTimeToDisplay(phTime)+'</p>');
		$('#'+location+'Temp-gauge-label').append('<p>Readings from: ' + formatDateToDisplay(tempTime)+ ' at: ' + formatTimeToDisplay(tempTime)+'</p>');
		$('#'+location+'Height-gauge-label').append('<p>Readings from: ' + formatDateToDisplay(gageHeightTime)+ ' at: ' + formatTimeToDisplay(gageHeightTime)+'</p>');

		// save values in case resonse is 0
		storeData(temp, gageHeight, ph, tempTime, gageHeightTime, phTime, location);

		updateInterval = 3000;//900000; // 15 min
		//console.log(location + ": last updated PH at"+ phTime + ", " + gageHeight);
	}

	// stores the last retreived water data from the request in case it cannot be updated.
	function storeData(temp, gageHeight, ph, ttime, htime, phtime, location){

		switch(location){
			case "acmetonia":
				alleghenyPh = ph;
				alleghenyTemp = temp;
				alleghenyGageHeight = gageHeight;

				aTempTime = ttime;
				aGageHeightTime = htime;
				aPhTime = phtime;

				break;
			case "elizabeth":
				monongahelaPh = ph;
				monongahelaTemp = temp;
				monongahelaGageHeight = gageHeight;

				mTempTime = ttime;
				mGageHeightTime = htime;
				mPhTime = phtime;

				break;
			case "ohioview":
				ohioPh = ph;
				ohioTemp = temp;
				ohioGageHeight = gageHeight;

				oTempTime = ttime;
				oGageHeightTime = htime;
				oPhTime = phtime;

				break;
		}
	}

	//			
	function setUpdateInterval(ui) {

		updateInterval = ui;
	}

	// capitalizes the first Letter of the string
	function capFirstLetter(string){

		return string.charAt(0).toUpperCase() + string.slice(1);
	}

	// extract date to display
	function formatDateToDisplay(string){
		var date = string.substr(0, 10);

		var year = date.substr(0, 4);
		var month = date.substr(5,2);
		var day = date.substr(8, 5);

		date = month+"/"+day+"/"+year;

		return date;
	}

	// extract time to display
	function formatTimeToDisplay(string){
		
		var time = string.substr(11,5);
		var hour = time.substr(0,2);
		var minutes = time.substr(3,4);
		
		if(parseInt(hour) > 12){
			hour = hour - 12;
			time = hour+":"+minutes+" pm";
		} else {
			time = time + "am";
		}
		return time;
	}

	// convert C to F
	function convertCtoF(c){
		// (°C × 9/5) + 32
		var f = c * 1.8 + 32;
		f = Math.round(f*100)/100;
		return f;
	}

	// handles the click event, sends the query
	function getIVdata(location) {

	   $.ajax({
	   	  type: "POST",
	      url:'php/saveInstantValues.php',
	      data: {riverLocation:location},
	      complete: function (response) {
	          console.log(location + ": updated json file");
	      },
	      error: function () {
	          console.error(location + ': Bummer: there was an error!');
	      },
	  });
	  return false;
	}
	var isShowing;

	// switch between graph and gauge
	$('#monongahelaPhGauge').click(function() {
		$( "#mGraph" ).show();
		$("#monongahelaPhGauge").hide();
	});

	$('#mGraph').click(function() {
		$("#monongahelaPhGauge").show();
		$( "#mGraph" ).hide();

		
	});

	$('#leftButton').click(function() {
		
		status--;
		if(status < 0) status = 0;

		$('#rightButton').show();

		switch(parseInt(status)){
			case 0: // 6 months ago
				$('#rightButton').css("background", "url('images/rightYesterday.png') center center no-repeat");
				$('#day').html("<h2>6 months ago</h2>");
				$('#leftButton').hide();
				break;
			case 1: // yesterday
				$('#leftButton').css("background", "url('images/left6.png') center center no-repeat");
				$('#day').html("<h2>yesterday</h2>");
				break;
			case 2: // today
				$('#leftButton').css("background", "url('images/leftYesterday.png') center center no-repeat");
				$('#day').html("<h2>today</h2>");
				break;
			default:
				console.error("problem updating gauges");
		}

		updateGauges(river1, status);
		updateGauges(river2, status);
		updateGauges(river3, status);
				
	});

	$('#rightButton').click(function() {
		
		status++;
		if(status < 0) status = 0;

		$('#leftButton').show();

		switch(parseInt(status)){
			case 0:
				$('#leftButton').css("background", "url('images/leftYesterday.png') center center no-repeat");
				$('#rightButton').css('background: none;');
				$('#day').html("<h2>6 months ago</h2>");
				break;
			case 1:
				$('#rightButton').css("background", "url('images/rightToday.png') center center no-repeat");
				$('#day').html("<h2>yesterday</h2>");
				break;
			case 2:
				$('#rightButton').css("background", "url('images/rightToday.png') center center no-repeat");
				$('#leftButton').css("background", "url('images/leftYesterday.png') center center no-repeat");
				$('#day').html("<h2>today</h2>");
				$('#rightButton').hide();
				break;
			default:
				alert("none of the above");
		}

		updateGauges(river1, status);
		updateGauges(river2, status);
		updateGauges(river3, status);

	});
}

if ( !window.isLoaded ) {
	window.addEventListener("load", function() {
		onDocumentReady();
	}, false);
} else {
	onDocumentReady();
}


</script>


</body>
</html>